<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Order Grab Mart Kilat</title>
    <meta content="Monitoring Data" name="description" />
    <meta content="inv,INV,awb,AWB,address,geocoding,longlat,lat,lng" name="keywords" />
    <meta name="author" content="Mr.S-149" />

    <link href="assets-blitz/img/logo/logo.jpg" rel="icon" />
    <link href="assets-blitz/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedcolumns/3.3.3/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.1.9/css/fixedHeader.dataTables.min.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/1.7.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/3.3.3/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.1.9/js/dataTables.fixedHeader.min.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <style>
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tbody tr:nth-child(odd) {
            background-color: #fff;
        }
        
        .table-container {
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
            table {
                font-size: 0.9rem;
            }
        }
        
        table td {
            max-height: 50px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            word-break: break-all;
            vertical-align: middle;
        }
        
        table th {
            vertical-align: middle;
            white-space: nowrap;
            color: white;
        }
        
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>

</head>

<body>

    <div class="container">
        <!-- Header -->
        <div class="row">
            <div class="col-12 text-center mt-4">
                <h1 class="display-5">New Order Grab Mart Kilat</h1>
                <p class="lead">Live orders feed, updated every minute.</p>
            </div>
        </div>

        <!-- Tabel -->
        <div class="row">
            <div class="col-12 table-container">
                <div class="table-responsive">
                    <table id="orderTable" class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Pickup Store</th>
                                <th>Dropoff Store</th>
                                <th>Pickup Address</th>
                                <th>Dropoff Address</th>
                                <th>Pickup District</th>
                                <th>Dropoff District</th>
                                <th>Pickup City</th>
                                <th>Dropoff City</th>
                                <th>Business</th>
                                <th>AWB Number</th>
                                <th>Merchant Order ID</th>
                                <th>Status</th>
                                <th>Created At</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data dari API akan ditambahkan di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Tabel -->
        <div class="row">
            <div class="col-12 table-container">
                <div class="table-responsive">
                    <h2>Master Data</h2>
                    <table id="masterDataTable" class="table table-bordered table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Business Hub</th>
                                <th>Address</th>
                                <th>District</th>
                                <th>City</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data dari JavaScript akan diisi di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Bootstrap JS dan Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const masterData = [{
            "business_hub": "Grabmart Daan Mogot",
            "address": "Jl. Lingkar Luar Barat No.3A, Kelurahan Cengkareng Barat, Kecamatan Cengkareng, Kota Jakarta Barat 11730",
            "district": "Kec. Cengkareng",
            "city": "Kota Jakarta Barat"
        }, {
            "business_hub": "Grabmart Fatmawati",
            "address": "Jl. RS. Fatmawati Raya, RT.3/RW.5, Kel. Cilandak Barat, Kec. Cilandak, Kota Jakarta Selatan, Daerah Khusus Ibukota Jakarta 12430",
            "district": "Kec. Cilandak",
            "city": "Kota Jakarta Selatan"
        }, {
            "business_hub": "Grabmart Kemayoran",
            "address": "Jl. Bungur Raya No.46 E, Bungur, Kemayoran, Jakarta Pusat, 10460",
            "district": "Kec. Kemayoran",
            "city": "Kota Jakarta Pusat"
        }, {
            "business_hub": "Grabmart Pegangsaan",
            "address": "LRT Pegangsaan, Unit R7 Depo LRT jakarta, jalan raya kelapa Nias, Pegangsaan dua, kelapa gading jakarta utara, 14250.",
            "district": "Kec. Kelapa Gading",
            "city": "Kota Jakarta Utara"
        }, {
            "business_hub": "Grabmart Meruya",
            "address": "Jalan Pesanggrahan 19A RT.001 RW.003 Kel. Meruya Utara, Kec. Kembangan, Jakarta Barat",
            "district": "Kec. Kembangan",
            "city": "Kota Jakarta Barat"
        }, {
            "business_hub": "Grabmart Setiabudi",
            "address": "Jl. Guntur No.76, RT.8/RW.4, Guntur, Kecamatan Setiabudi, Kota Jakarta Selatan, Daerah Khusus Ibukota Jakarta 12980",
            "district": "Kec. Setiabudi",
            "city": "Kota Jakarta Selatan"
        }, {
            "business_hub": "Grabmart Tanjung Duren",
            "address": "Jl. Tj. Duren Barat 1 No.12B, RT.6/RW.3, Tj. Duren Utara, Kec. Grogol petamburan, Kota Jakarta Barat, Daerah Khusus Ibukota Jakarta 11470",
            "district": "Kec. Grogol petamburan",
            "city": "Kota Jakarta Barat"
        }, {
            "business_hub": "Grabmart Veteran",
            "address": "Jl.Kesehatan Raya RT 1 / RW 6, Bintaro, Kec.Pesanggrahan, Kota Jakarta Selatan,12330",
            "district": "Kec. Pesanggrahan",
            "city": "Kota Jakarta Selatan"
        }, {
            "business_hub": "Grabmart Dewi Sartika",
            "address": "Jalan Dewi Sartika No.9, Depok, Kec. Pancoran Mas, Kota Depok, Jawa Barat 16430",
            "district": "Kec. Pancoran Mas",
            "city": "Kota Depok"
        }, {
            "business_hub": "Grabmart Emporium",
            "address": "Emporium Pluit Mall Lantai LG, Jalan Pluit Selatan Raya, Penjaringan, RT.23/RW.8, Penjaringan, Kec. Penjaringan, Jkt Utara, Daerah Khusus Ibukota Jakarta 14440",
            "district": "Kec. Penjaringan",
            "city": "Kota Jakarta Utara"
        }, {
            "business_hub": "Grabmart Graha Bintaro",
            "address": "Graha Raya Mall Graha Bintaro ,Jl Blvd Graha Raya , Paku Jaya ,Serpong Utara",
            "district": "Kec. Serpong Utara",
            "city": "Kota Tangerang Selatan"
        }, {
            "business_hub": "Grabmart X-Mall",
            "address": "Komp.Billy Moon jl.Raya Kalimalang No.1 RT 1/rw.10,Pondok Kelapa ,duren sawit,kota jakarta timur ,DKI Jakarta INDONESIA",
            "district": "Kec. Duren Sawit",
            "city": "Kota Jakarta Timur"
        }, {
            "business_hub": "Grabmart ITC BSD",
            "address": "Jl. Pahlawan Seribu No.12, Lengkong Wetan, Kec. Serpong, Kota Tangerang Selatan, Banten 15310",
            "district": "Kec. Serpong",
            "city": "Kota Tangerang Selatan"
        }, {
            "business_hub": "Grabmart Bekasi Juanda",
            "address": "Grabmart Kilat Juanda Bekasi, Transmart Juanda Bekasi Lantai 1, Jl. Insinyur H. Juanda No.19, RT.003/RW.011, Margahayu, Kec. Bekasi Tim., Kota Bks, Jawa Barat 17113",
            "district": "Kec. Bekasi Timur",
            "city": "Kota Bekasi"
        }, {
            "business_hub": "Grabmart Cibubur",
            "address": "Grabmart kilat - TSM Cibubur, Jl.Alternatif Cibubur No . 230 A , Harjamukti , Cimanggis , Kota Depok , Jawa Barat",
            "district": "Kec. Cimanggis",
            "city": "Kota Depok"
        }, {
            "business_hub": "Grabmart Cempaka Putih",
            "address": "Transmart Cempaka Putih, Jl. Jenderal Ahmad Yani No.83, RT.10/RW.7, Cemp. Putih Tim., Kec. Cemp. Putih, Kota Jakarta Pusat, Daerah Khusus Ibukota Jakarta 10510",
            "district": "Kec. Cempaka Putih",
            "city": "Kota Jakarta Pusat"
        }];

        $(document).ready(function() {
            const tableBody = $('#masterDataTable tbody');

            masterData.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.business_hub}</td>
                        <td>${item.address}</td>
                        <td>${item.district}</td>
                        <td>${item.city}</td>
                    </tr>
                `;
                tableBody.append(row);
            });

            $('#masterDataTable').DataTable(); // Initialize DataTable plugin
        });

        // URL API
        const apiUrl = 'https://adminapis.rideblitz.id/api/v1/unbatched_orders?dir=1&page=1&business=33&limit=100';

        // Fungsi untuk memanggil data menggunakan AJAX dan jQuery
        function fetchData() {
            $.ajax({
                url: apiUrl,
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    displayData(response.results);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching data:', error);
                }
            });
        }

        function displayData(orders) {
            const tableBody = $('#orderTable tbody');
            tableBody.empty(); // Kosongkan tabel sebelum menambahkan data baru

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set waktu ke tengah malam untuk perbandingan
            console.log(today);

            const awbToday = []; // Array untuk menyimpan AWB yang dibuat hari ini
            let totalNew = 0;

            orders.forEach(order => {
                const createdAtFormatted = formatDate(order.created_at);

                let milliseconds = Number(order.created_at > 1e15 ? order.created_at / 1e6 : order.created_at);
                const createdAtDate = new Date(milliseconds);
                createdAtDate.setHours(0, 0, 0, 0); // Set waktu ke tengah malam untuk perbandingan

                // Cek apakah order dibuat hari ini
                if (createdAtDate.getTime() === today.getTime()) {
                    totalNew++
                    awbToday.push(order.awb_number);
                }

                // Cari alamat yang sesuai berdasarkan business_hub
                const hubData = masterData.find(item => item.business_hub === order.business_hub);
                const pickupAddress = hubData ? hubData.address : "Address not found"; // Jika tidak ditemukan, tampilkan "Address not found"
                const pickupDistrict = hubData ? hubData.district : "District not found"; // Jika tidak ditemukan, tampilkan "Address not found"

                // Cari business hub yang sesuai berdasarkan dropoff_district
                const businessHubData = masterData.find(item => item.district === order.dropoff_district);
                const dropoffStore = businessHubData ? businessHubData.business_hub : "business Hub Data not found"; // Jika tidak ditemukan, tampilkan "Address not found"
                const dropoffAddress = businessHubData ? businessHubData.address : "dropoff Address Data not found";

                // Tambahkan alamat ke dalam row
                const row = `
            <tr>
                <td>${order.business_hub}</td>
                <td>${dropoffStore}</td>
                <td>${pickupAddress}</td>
                <td>${dropoffAddress}</td>
                <td>${pickupDistrict}</td>
                <td>${order.dropoff_district}</td>
                <td>${order.pickup_city}</td>
                <td>${order.dropoff_city}</td>
                <td>${order.business}</td>
                <td>${order.awb_number}</td>
                <td>${order.merchant_order_id}</td>
                <td>${order.order_status}</td>
                <td>${createdAtFormatted}</td>
            </tr>
        `;

                tableBody.append(row);
            });

            // Jika ada AWB yang dibuat hari ini, tampilkan alert dan mainkan suara
            if (awbToday.length > 0) {
                const notificationSound = new Audio('assets-blitz/audio/ringtone.mp3');
                notificationSound.play();
                setTimeout(() => {
                    alert(`New Orders : ${totalNew}\n${awbToday.join(', ')}`);
                }, 3000);
            }

            initializeDataTable();
        }

        // Fungsi untuk mengonversi timestamp menjadi format tanggal yang lebih mudah dibaca
        function formatDate(timestamp) {
            let milliseconds;

            if (timestamp > 1e15) {
                milliseconds = Number(timestamp) / 1e6; // Ubah dari nanodetik ke milidetik
            } else {
                milliseconds = Number(timestamp); // Anggap sudah dalam milidetik
            }

            const date = new Date(milliseconds);
            if (isNaN(date.getTime())) {
                return 'Invalid Date'; // Jika tidak valid
            }

            const options = {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };

            return date.toLocaleString('id-ID', options).replace('pukul', ':').trim();
        }

        // Fungsi untuk menginisialisasi DataTable
        function initializeDataTable() {
            // Jika DataTable sudah ada, hancurkan terlebih dahulu
            if ($.fn.DataTable.isDataTable('#orderTable')) {
                $('#orderTable').DataTable().destroy();
            }

            // Inisialisasi DataTable
            $('#orderTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                scrollX: true, // Enable horizontal scrolling
                scrollY: 300, // Set max height for vertical scrolling
                fixedHeader: true, // Freeze header
                fixedColumns: {
                    leftColumns: 1 // Freeze first and second columns
                },
                dom: 'lBfrtip',
                buttons: [{
                    extend: 'copy',
                    exportOptions: {
                        // This will exclude the header
                        modifier: {
                            page: 'all'
                        },
                        format: {
                            body: function(data, row, column) {
                                // return the data as is, excluding headers
                                return data;
                            }
                        }
                    }
                }, {
                    extend: 'excel',
                    exportOptions: {
                        modifier: {
                            page: 'all'
                        },
                        format: {
                            body: function(data, row, column) {
                                return data;
                            }
                        }
                    }
                }, {
                    extend: 'csv',
                    exportOptions: {
                        modifier: {
                            page: 'all'
                        },
                        format: {
                            body: function(data, row, column) {
                                return data;
                            }
                        }
                    }
                }, {
                    extend: 'pdf',
                    exportOptions: {
                        modifier: {
                            page: 'all'
                        },
                        format: {
                            body: function(data, row, column) {
                                return data;
                            }
                        }
                    }
                }, {
                    extend: 'print',
                    exportOptions: {
                        modifier: {
                            page: 'all'
                        },
                        format: {
                            body: function(data, row, column) {
                                return data;
                            }
                        }
                    }
                }],
                lengthMenu: [10, 25, 50, 100], // Opsi jumlah baris yang akan ditampilkan
                pageLength: 10 // Jumlah baris default yang akan ditampilkan
            });
        }

        // Panggil fetchData pertama kali saat halaman dimuat
        $(document).ready(function() {
            fetchData();
            // Panggil fungsi fetchData setiap 1 menit
            setInterval(fetchData, 60000); // 60 detik
        });
    </script>

</body>

</html>