<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menampilkan dan Mengirim Data ke WhatsApp</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        .draggable {
            cursor: move;
            padding: 8px;
            margin: 4px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
        }

        #preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="my-4">Form Data</h1>
        <div class="form-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Cari data...">
        </div>
        <form id="dataForm">
            <h3>Pilih Data:</h3>
            <div id="output" class="mb-4">
                <!-- Data dari spreadsheet akan ditampilkan di sini -->
            </div>
        </form>

        <h3>Preview Data yang Dipilih:</h3>
        <div id="preview">
            <!-- Preview dari data yang dipilih akan ditampilkan di sini -->
        </div>

        <div class="form-group mt-4">
            <label for="nameInput">Nama:</label>
            <input type="text" id="nameInput" name="nameInput" class="form-control" required>
        </div>

        <button type="button" id="sendButton" class="btn btn-primary mt-4">Kirim Data ke WhatsApp</button>
    </div>

    <script>
        const sheetURL = "https://docs.google.com/spreadsheets/d/1NStnH7B7HCvvxojIlAP-VFKMLpdRCmovKFN6Loe1n6w/pub?gid=1795785147&single=true&output=csv";
        const outputDiv = document.getElementById("output");
        const previewDiv = document.getElementById("preview");
        let selectedData = [];

        fetch(sheetURL)
            .then(response => response.text())
            .then(data => {
                const rows = data.split("\n");
                rows.slice(1).forEach(row => {
                    const cells = row.split(",");
                    if (cells[0]) {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "draggable";
                        itemDiv.innerHTML = `<input type="checkbox" name="dataSelection" value="${cells[0]}"> ${cells[0]}`;
                        outputDiv.appendChild(itemDiv);
                    }
                });
            })
            .catch(error => console.error("Error fetching data:", error));

        document.getElementById("searchInput").addEventListener("input", function () {
            const searchValue = this.value.toLowerCase();
            const checkboxes = document.querySelectorAll('input[name="dataSelection"]');
            checkboxes.forEach(checkbox => {
                const label = checkbox.parentElement.textContent.toLowerCase();
                checkbox.parentElement.style.display = label.includes(searchValue) ? "" : "none";
            });
        });

        outputDiv.addEventListener("change", function (event) {
            const checkbox = event.target;
            if (checkbox.checked) {
                selectedData.push(checkbox.value);
            } else {
                selectedData = selectedData.filter(item => item !== checkbox.value);
            }
            updatePreview();
        });

        function updatePreview() {
            previewDiv.innerHTML = "";
            selectedData.forEach(item => {
                const itemDiv = document.createElement("div");
                itemDiv.className = "draggable";
                itemDiv.textContent = item;
                previewDiv.appendChild(itemDiv);
            });
            initSortable(); // Inisialisasi Sortable setelah memperbarui preview
        }

        function initSortable() {
            new Sortable(previewDiv, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function (evt) {
                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;
                    const movedItem = selectedData.splice(oldIndex, 1)[0];
                    selectedData.splice(newIndex, 0, movedItem);
                    updatePreview();
                }
            });
        }

        document.getElementById("sendButton").addEventListener("click", function () {
            const name = document.getElementById("nameInput").value;
            const message = `Nama: ${name}\nData yang Dipilih:\n${selectedData.join('\n')}`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappURL = `https://wa.me/?text=${encodedMessage}`;
            window.open(whatsappURL, '_blank');
        });
    </script>
</body>

</html>
