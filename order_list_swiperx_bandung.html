<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menampilkan dan Mengirim Data ke WhatsApp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <style>
        .draggable {
            cursor: move;
            padding: 8px;
            margin: 4px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            user-select: none; /* Prevents text selection */
        }
        #previewSection {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            padding: 10px;
        }
        #outputSection {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
        }
        .search-container {
            position: relative;
        }
        .clear-icon {
            position: absolute;
            right: 10px;
            top: 70%;
            transform: translateY(-50%);
            cursor: pointer;
            font-size: 1.2rem;
            color: #ccc;
        }
    </style>
</head>
<body class="container mt-5">
    <h1>Form Data</h1>
    <form id="dataForm">
        <div class="mb-3 search-container">
            <label for="searchInput" class="form-label">Search Data:</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Cari data...">
            <span class="clear-icon" id="clearSearch">&times;</span>
        </div>

        <div id="outputSection">
            <!-- Data dari spreadsheet akan ditampilkan di sini -->
        </div>

        <h3>Data Terpilih:</h3>
        <div id="previewSection">
            <!-- Data yang dipilih oleh user akan dipreview di sini -->
        </div>

        <div class="mb-3">
            <label for="nameInput" class="form-label">Nama:</label>
            <input type="text" id="nameInput" name="nameInput" class="form-control" required>
        </div>

        <button type="submit" class="btn btn-primary">Kirim Data ke WhatsApp</button>
    </form>

    <script>
        let selectedData = [];

        const sheetURL = "https://docs.google.com/spreadsheets/d/1NStnH7B7HCvvxojIlAP-VFKMLpdRCmovKFN6Loe1n6w/pub?gid=1795785147&single=true&output=csv";

        // Ambil data dari Google Sheets
        fetch(sheetURL)
            .then(response => response.text())
            .then(data => {
                const rows = data.split("\n");
                const outputDiv = document.getElementById("outputSection");

                // Loop through each row and add it to the output section
                rows.slice(1).forEach(row => {
                    const cells = row.split(",");
                    if (cells[0]) {
                        const item = document.createElement("div");
                        // item.className = "draggable";
                        item.innerHTML = `<input type="checkbox" value="${cells[0]}" class="draggable-checkbox"> ${cells[0]}`;
                        item.addEventListener("change", function(event) {
                            if (event.target.classList.contains('draggable-checkbox')) {
                                if (event.target.checked) {
                                    addToPreview(event.target.value);
                                } else {
                                    removeFromPreview(event.target.value);
                                }
                            }
                        });
                        outputDiv.appendChild(item);
                    }
                });

                // Initialize SortableJS for drag-and-drop functionality
                Sortable.create(outputDiv, {
                    group: 'shared',
                    animation: 150,
                    onEnd: function (evt) {
                        const item = evt.item;
                        const data = item.textContent.trim();
                        if (outputDiv.contains(item)) {
                            removeFromPreview(data);
                        } else {
                            addToPreview(data);
                        }
                    }
                });

                Sortable.create(document.getElementById('previewSection'), {
                    group: 'shared',
                    animation: 150,
                    onEnd: function (evt) {
                        const item = evt.item;
                        const data = item.textContent.trim();
                        if (previewSection.contains(item)) {
                            addToPreview(data);
                        } else {
                            removeFromPreview(data);
                        }
                    }
                });

            })
            .catch(error => console.error("Error fetching data:", error));

        function addToPreview(value) {
            if (!selectedData.includes(value)) {
                selectedData.push(value);
                updatePreview();
            }
        }

        function removeFromPreview(value) {
            selectedData = selectedData.filter(item => item !== value);
            updatePreview();
        }

        function updatePreview() {
            const previewDiv = document.getElementById("previewSection");
            previewDiv.innerHTML = "";

            selectedData.forEach(data => {
                const item = document.createElement("div");
                item.className = "draggable";
                item.innerHTML = `<span>${data}</span>`;
                previewDiv.appendChild(item);
            });
        }

        // Kirim data ke WhatsApp
        document.getElementById("dataForm").addEventListener("submit", function(event) {
            event.preventDefault();

            const name = document.getElementById("nameInput").value;

            // Build message based on the order of selected data in preview
            const message = `Nama: ${name}\nData yang Dipilih:\n${selectedData.join('\n')}`;
            const encodedMessage = encodeURIComponent(message);

            // Detect if the user is on mobile or desktop
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            let whatsappURL;
            if (isMobile) {
                // If on mobile, use WhatsApp URI scheme
                whatsappURL = `whatsapp://send?text=${encodedMessage}`;
            } else {
                // If on desktop, use WhatsApp Web
                whatsappURL = `https://web.whatsapp.com/send?text=${encodedMessage}`;
            }

            // Open the WhatsApp URL
            window.open(whatsappURL, '_blank');
        });

        // Filter data based on search input
        document.getElementById("searchInput").addEventListener("input", function() {
            const filter = this.value.toLowerCase();
            const items = document.querySelectorAll("#outputSection .draggable");

            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(filter)) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        });

        // Clear search input when "X" icon is clicked
        document.getElementById("clearSearch").addEventListener("click", function() {
            const searchInput = document.getElementById("searchInput");
            searchInput.value = "";
            searchInput.dispatchEvent(new Event('input'));
        });
    </script>
</body>
</html>
